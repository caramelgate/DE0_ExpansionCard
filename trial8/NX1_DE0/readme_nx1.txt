NX1とは

NX1は、X1CENTERの佐藤氏が公開している開発版のNISE X1を元にして、スーパーインポーズ機能を追加したものです。
スーパーインポーズなどビデオ機能の拡充を優先するため、元となったNISE X1よりも実機の再現性は低下しています。
佐藤氏のNISE X1に対する方針は実機の再現性を追求することですが、NX1は実機の再現よりもX1が本来持っていたビデオ機能の拡充を目的とします。
したがって再現度の高さを求めるなら、NISE X1の検討をおすすめします。

なおシミュレーションおよび製造検証が行いやすいよう、クロック系統の削減や非同期ラッチの同期化などは適宜修正しています。
またFPGAと異なり、実機やASICなどは電源投入時にラッチの内容が不定なので、リセット信号で初期化を行うように直しています。
ちなみにFPGAでよくあるリセットしなくても初期値が付いているラッチはASICでは実現できません。かならずリセット信号で明示的に初期値を読み込ませましょう。

デバイス依存はdef_DEVICEを参照するようにしているので、上位からオーバーライドすれば対象モジュールの書き換えは不要です。


NX1が予定すること

NX1はX1の互換機です。X1TURBOにする予定はありませんが、一部の機能は実装します。
X1なのでスーパーインポーズ機能を搭載します。
デジタルテロッパーは未定です。

互換機なので、不都合のない程度に機能を省略します。
USBパッドとか対応するといいなあ。

内部バスの構成をZ80互換バスとメモリバスに分離すれば速くなるかな。


動作環境

アルテラ Cyclone3以降、ザイリンクス Spartan3A以降を搭載したFPGA基板が対象です。

対応メモリはSDR-SDRAM(MIG互換)、cellula ram(MIG互換)、DDR-SDRAM(ザイリンクス MIG使用)です。
SDR-SDRAMコントローラーとMIG互換インターフェースをフルスクラッチで用意しました。
メインメモリとビデオメモリを共用します。アクセスが重なるとレイテンシーが長くなります。
メモリインターフェースをAMBAに対応するのは未定です。

CRTCは外部同期と任意拡大に対応します。見かけの解像度は320x200と640x200です。
同期発生回路をCRTCから分離したので、実際の表示解像度は640x480〜1920x1080まで対応します。
640x480〜1920x1080までのディスプレイと、800x480〜1024x768のLCDパネルに対応します。
DE0などDDR-SDRAM以外のFPGA基板ではメモリバンド幅の関係で1920x1080には対応しません。

FPGA基板に映像入力をすれば、映像信号に対してスーパーインポーズ表示が可能です。

TERASIC DE0(Cyclone3)は開発対象基板です。
AVNET MicroBoard(Spartan6LX)は対応予定です。たぶん。
DIGILENT Nexys3(Spartan6LX)は対応予定です。たぶん。


状況 2014/JAN/10版

IPLが起動します。IPLだけが起動します。

現在の対応基板はTERASIC DE0(Cyclone3)です。

NISE X1のメモリコントローラーをMIGインターフェースに載せ換え、SDRAMを接続しました。
メモリのタイミングとCPUの動作タイミングが変わったので、SUB CPUによるDMAとFDCのエミュレーションは使用不能になりました。
CRTCを載せ替えました。見かけの解像度は320x200と640x200ですが、40桁の補正は未実装です。
同期発生回路の解像度は800x480と1024x768です(現状はフルHDのピクセルクロック周波数がずれています)。

非対応機能

メモリコントローラーを変えた影響が広範囲におよぶので、X1TURBOの機能は使用しません。
DE0基板は標準でシリアルポートコネクタが実装されていないので、NOICEデバッガは使用しません。
SUB CPUによるFDDエミュレーションはバスタイミングが変わったので使用不能です。
SUB CPUによるZ80DMAエミュレーションはバスタイミングが変わったので使用不能です。

X1TURBOの漢字TEXTを表示するにはフォントデータをSDRAMに格納するしか方法がなさそうですが、MIGのレイテンシーが長いので対応しません。
実装するなら先行スキャンしてフォントデータをキャッシュすればよさそうですが、漢字ROMのデータを持っていないしなあ。


状況 2014/JAN/13版

FDC MB8877がシミュレーションレベルでうごくようです。


状況 2014/JAN/17版

シミュレーション用にいろいろと修正しました。
検証用のIPLをぷにゅ氏作成のIPL x1ipl101に変更し、標準で追加しました。
合成用にFDC MB8877を追加しました。
起動テスト用に、オンチップメモリへ筑紫版X1用S-OS SWORDをFDイメージとして格納しました。
現在DE0での使用状況は27%です。デバッグしてないのであてになりませんが。
さて、うごかないんでデバッグしないと。


状況 2014/JAN/20版

FDCシミュレーションを更新しました。
シーク動作が勘違いしてます。


状況 2014/JAN/21版

なんか起動。現状ではGRAMがアクセス不能(デバッグしてない)なのでIPLの該当部分を外す。
S-OSはメッセージを出してプロンプトまで行くが、GRAMをアクセスして昇天していると思われる。
デバッグモード有効なので、テキスト画面の表示とかは実機と異なる。


状況 2014/JAN/24版

GRAMの同時書き込み解除で無反応のままになっていたのを修正。
8255のWRとCSが同時変化(レーシング)して動作不良なので修正。ついでに同期版でも試してみる。


長嶋(T.NG) caramelgate@gmail.com
